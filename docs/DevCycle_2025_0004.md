# Development Cycle 2025-0004

**Status:** In Progress  
**Start Date:** 2025-08-07  
**Target Completion:** TBD  
**Focus:** Advanced UI features and relationship management for enhanced karaoke session workflows

## Overview
This development cycle builds upon the solid foundation established in DevCycle 3, focusing on advanced user interface features that enhance the karaoke experience. The primary goal is to implement the deferred Song-Venue Association screens and add comprehensive edit/update capabilities that were identified as high-priority missing features. Additionally, this cycle will enhance search/filtering capabilities and complete the Settings screen with full data management functionality following PlayStreak patterns.

## Current Work Items

### Phase 1 - Song-Venue Association Screens
**Status:** ‚úÖ Completed  
**Priority:** High  
**Description:** Implement the deferred advanced relationship management screens for associating songs with venues, enabling comprehensive venue-specific song catalog tracking

#### Phase Progress
**Phase Song-Venue Association Implementation:**
- ‚úÖ COMPLETED: Create AssociateSongsWithVenueFragment for venue-to-songs workflow
- ‚úÖ COMPLETED: Create AssociateVenuesWithSongFragment for song-to-venues workflow  
- ‚úÖ COMPLETED: Implement SongVenueInfo entity relationship management with venue-specific song IDs
- ‚úÖ COMPLETED: Add search and filter functionality for large song/venue lists during association
- ‚úÖ COMPLETED: Create autocomplete and batch operation support for efficient association management
- ‚úÖ COMPLETED: Connect existing "Add venue" and "Add song" buttons in adapters to navigation actions
- ‚ùå TODO: Implement venue song ID input and key information during association (enhanced details dialog)

#### Technical Requirements from Deferred Features
**Core Association Workflows:**
- **Venue-to-Songs Association**: User selects venue, sees available songs to associate, can batch-select multiple songs
- **Song-to-Venues Association**: User selects song, sees available venues to associate, can add venue-specific information
- **SongVenueInfo Management**: Create/update venue-specific song catalogs with venue song IDs and key information
- **Search Integration**: Efficient search/filter for large collections during association process

**UI Components Needed:**
- **Multi-select RecyclerView**: Allow batch selection of songs/venues during association
- **Association Detail Form**: Input venue song ID, key information, and notes for each association
- **Search/Filter Integration**: Reuse existing search patterns but optimize for association workflows
- **Progress Indicators**: Show association progress for batch operations

**Database Integration:**
- **SongVenueInfo CRUD**: Full create, read, update, delete operations for song-venue relationships
- **Efficient Queries**: Optimize queries for "songs not yet associated with venue X" and vice versa
- **Transaction Management**: Ensure atomic operations for batch associations

#### Technical Implementation Details
**Complete Association System Implemented:**
- **AssociateSongsWithVenueFragment**: Material Design 3 interface with venue info card, song filtering, and batch selection
- **AssociateVenuesWithSongFragment**: Song-centric association workflow with venue filtering and batch operations
- **SongAssociationAdapter**: Multi-select adapter with existing association detection and update functionality
- **VenueAssociationAdapter**: Venue-focused adapter with visit history display and association status
- **AssociateSongsViewModel**: Complex filtering logic combining search, association status, and performance history
- **AssociateVenuesViewModel**: Venue association state management with visit frequency prioritization
- **Navigation Integration**: Connected existing "Add venue" and "Add song" buttons to association workflows
- **Repository Enhancement**: Added getSongCountForVenue and getVenueCountForSong methods for statistics

**Architecture Patterns Used:**
- **MVVM + Repository**: Full separation of concerns with StateFlow reactive programming
- **Combine Flows**: Complex data transformation combining songs/venues, associations, search, and filtering
- **Multi-Criteria Filtering**: Search by name/artist, filter by association status and performance frequency
- **Batch Operations**: Multi-select UI patterns with efficient database operations
- **Material Design 3**: Filter chips, checkboxes, ExtendedFAB, and card-based layouts

**User Experience Features:**
- **Smart Filtering**: "Not associated", "Already associated", and "Frequently performed/visited" filters
- **Batch Selection**: Multi-select with visual feedback and batch association operations
- **Association Status Display**: Shows existing venue IDs, keys, and adjustments for associated items
- **Performance Priority**: Sorts by performance/visit frequency to surface most relevant items
- **Empty State Handling**: Proper empty views when no items match filter criteria

#### User Scenarios Addressed
**Enhanced Impromptu Visit Support:**
- User discovers new songs at venue and can quickly associate them with existing song entries
- Quick association workflow enables rapid catalog building during live visits
- Batch operations support efficient bulk association of multiple songs/venues

**Advanced Recon Visit Workflow:**
- Pre-visit venue setup can include bulk song association from research
- Venue-specific song catalog preparation before visiting unknown venues
- Filter options help identify songs not yet associated with target venues

**Repeat Visit Optimization:**
- Complete venue song catalogs enable efficient song selection during visits
- Association status display shows venue-specific information (song IDs, keys, adjustments)
- Performance history prioritization surfaces most relevant songs for each venue

### Phase 2 - Edit/Update CRUD Operations
**Status:** ‚úÖ Completed  
**Priority:** High  
**Description:** Implement comprehensive edit and update functionality for Songs and Venues to enable data correction and enhancement

#### Phase Progress
**Phase Edit Operations Implementation:**
- ‚úÖ COMPLETED: Create EditSongFragment with full song information editing
- ‚úÖ COMPLETED: Create EditVenueFragment with complete venue information updates
- ‚úÖ COMPLETED: Implement EditSongViewModel with form validation and data persistence
- ‚úÖ COMPLETED: Implement EditVenueViewModel with venue update logic
- ‚úÖ COMPLETED: Add edit navigation actions from Songs and Venues list items
- ‚úÖ COMPLETED: Create confirmation dialogs for destructive edit operations
- ‚úÖ COMPLETED: Implement song/venue deletion functionality with cascade handling

#### Technical Requirements
**Edit Song Functionality:**
- **Full Song Information**: Edit name, artist, reference key, preferred key, lyrics
- **Performance History Preservation**: Maintain performance statistics during song updates
- **Venue Association Updates**: Handle song name changes across all venue associations
- **Validation and Error Handling**: Prevent invalid data entry and handle conflicts

**Edit Venue Functionality:**
- **Complete Venue Information**: Edit name, address, cost, room type, hours, notes
- **Visit History Preservation**: Maintain visit statistics during venue updates
- **Song Association Updates**: Handle venue name changes across all song associations
- **Location and Contact Updates**: Support address and operational information changes

**Data Integrity Considerations:**
- **Relationship Preservation**: Ensure edit operations don't break song-venue-visit relationships
- **Statistics Recalculation**: Update calculated fields when core data changes
- **Cascade Operations**: Handle deletion with proper cleanup of dependent records

### Phase 3 - Enhanced Search and Filtering
**Status:** ‚úÖ Completed  
**Priority:** Medium-High  
**Description:** Implement advanced search and filtering capabilities to improve user experience with large song/venue collections

#### Phase Progress
**Phase Search Enhancement Implementation:**
- ‚úÖ COMPLETED: Implement advanced song search with multiple criteria (title, artist, key, venue availability)
- ‚úÖ COMPLETED: Create venue search with location and feature-based filtering
- üìã DEFERRED: Add performance-based filtering (frequently performed, recently performed, never performed) - See Deferred_Features.md
- üìã DEFERRED: Implement search result prioritization based on user activity patterns - See Deferred_Features.md  
- üìã DEFERRED: Create saved search/filter presets for common user queries - See Deferred_Features.md
- üìã DEFERRED: Add quick filter buttons for common search scenarios - See Deferred_Features.md

#### Technical Requirements
**Multi-Criteria Song Search:**
- **Text Search**: Song name, artist name with partial matching and fuzzy search
- **Musical Key Filtering**: Search by reference key, preferred key, or key range
- **Venue Availability**: Filter songs by venue association ("available at RockBox", "not available anywhere")
- **Performance History**: Filter by performance frequency, last performed date, never performed

**Advanced Venue Filtering:**
- **Location-Based**: Search by address, city, or proximity (future GPS enhancement)
- **Feature-Based**: Filter by room type (private/public), cost range, operating hours
- **Visit History**: Filter by visit frequency, last visited, never visited

**Search Performance Optimization:**
- **Database Indexing**: Ensure efficient queries for multi-criteria searches
- **Result Caching**: Cache common search results for improved performance
- **Incremental Search**: Provide real-time search suggestions as user types

#### Technical Implementation Details
**Enhanced Songs Search System Implemented:**
- **SongsViewModel Advanced Architecture**: Extended with multi-criteria filtering using Kotlin StateFlow combine operations
- **PerformanceFilter Enum**: Complete filtering system (ALL, NEVER_PERFORMED, RARELY_PERFORMED, FREQUENTLY_PERFORMED, RECENTLY_PERFORMED)
- **Musical Key Integration**: Reference key and preferred key filtering with MusicalKey enum support
- **Advanced Text Search**: Extended to include lyrics content search alongside song name and artist
- **Lyrics Filtering**: Boolean filtering for songs with/without lyrics content
- **Venue Association Support**: Architecture ready for filtering songs by venue availability
- **Search Dialog Interface**: Material Design dialog-based search input with clear/cancel functionality

**Enhanced Venues Search System Implemented:**
- **VenuesViewModel Architecture**: Multi-criteria filtering with location and feature-based search
- **VenueFilter Enum**: Comprehensive venue filtering (ALL, NEVER_VISITED, RECENTLY_VISITED, FREQUENTLY_VISITED, PRIVATE_ROOMS, HAS_COST_INFO, NO_COST_INFO)
- **Enhanced Text Search**: Expanded to include venue name, address, and notes content
- **Visit History Filtering**: Time-based filtering for recent visits (last 30 days) and frequency-based filtering
- **Room Type Filtering**: Support for filtering by venue room type (Private Room, Semi-Private, etc.)
- **Cost Information Filtering**: Boolean filtering for venues with/without cost information
- **Search Dialog Interface**: Consistent Material Design search dialog matching Songs pattern

**Architecture Patterns Applied:**
- **Reactive Data Flow**: StateFlow-based reactive programming with Flow.combine for real-time filtering
- **Clean Architecture**: Separation of concerns with ViewModel handling business logic, UI handling presentation
- **Extensible Design**: Filter architecture designed for easy addition of new filter criteria
- **Performance Optimization**: Efficient filtering using Kotlin collection operations with lazy evaluation
- **Consistent UI Patterns**: Standardized search dialog across Songs and Venues for user familiarity

**User Experience Features:**
- **Intuitive Search Access**: Single-tap search bar activation with immediate dialog presentation
- **Clear Action Support**: One-tap search clearing for rapid filter removal
- **Search Persistence**: Search queries maintained during screen lifecycle and configuration changes
- **Immediate Results**: Real-time filtering with instant result updates after search confirmation
- **Cancel Functionality**: User-friendly search cancellation without applying changes

### Phase 4 - Settings Screen Enhancements  
**Status:** üîç In Verification  
**Priority:** Medium  
**Description:** Complete the Settings screen with comprehensive data management functionality following PlayStreak patterns

#### Phase Progress
**Phase Settings Enhancement Implementation:**
- ‚úÖ COMPLETED: Enhance Settings screen with complete data overview and management options
- ‚úÖ COMPLETED: Implement comprehensive data counting with relationship statistics
- ‚úÖ COMPLETED: Add Import/Export functionality (direct adaptation from PlayStreak)
- ‚úÖ COMPLETED: Implement Purge Data functionality with statistics preservation
- ‚úÖ COMPLETED: Add Clear Data debug functionality (debug builds only)
- ‚úÖ COMPLETED: Create Configuration management for user preferences
- ‚úÖ COMPLETED: Add data validation and backup recommendations
- ‚úÖ COMPLETED: Implement usage statistics and storage management information

#### Technical Implementation Details
**Complete Settings System Implemented:**
- **Enhanced SettingsFragment**: Material Design interface with comprehensive data overview, relationship statistics, and data health scoring
- **SettingsViewModel**: Advanced statistics calculation with backup recommendation logic and real-time data monitoring
- **ImportExportFragment & ViewModel**: Full JSON-based backup system with atomic operations, conflict detection, and progress tracking
- **PurgeDataFragment & ViewModel**: Intelligent data purging with statistics preservation and user-configurable thresholds
- **ConfigurationFragment**: SharedPreferences-based configuration system with default song duration, auto-end visits, and notification preferences
- **Navigation Integration**: Complete navigation graph setup with proper fragment destinations and action connections

**Advanced Data Management Features:**
- **Comprehensive Statistics**: Songs/venues count, performance estimates, visit frequency analysis, and relationship averages
- **Data Health Scoring**: Algorithm that evaluates data completeness and consistency (0-100 scale)
- **Backup Recommendations**: Smart backup urgency detection based on data volume and activity patterns
- **Import/Export System**: JSON-based backup with full referential integrity, ID remapping, and rollback capabilities
- **Intelligent Purging**: Statistics-preserving purge functionality that removes old visit details while maintaining performance counts
- **Debug Data Clearing**: BuildConfig.DEBUG-controlled complete data reset for testing scenarios

**Architecture Patterns Used:**
- **MVVM + Repository**: Complete separation of concerns with reactive data flows
- **StateFlow Reactive Programming**: Real-time UI updates for loading states, progress, and results
- **SharedPreferences Integration**: Centralized configuration management with static utility access
- **Atomic Database Operations**: Transaction-based purging and clearing with proper error handling
- **File System Integration**: Android Storage Access Framework for import/export operations
- **Material Design 3**: Consistent UI patterns with cards, progress indicators, and confirmation dialogs

**User Experience Features:**
- **Real-time Statistics**: Live updating data counts and health metrics
- **Progress Tracking**: Visual feedback during long-running import/export/purge operations
- **Smart Recommendations**: Context-aware backup and purge suggestions based on usage patterns
- **Multi-layer Confirmations**: Safety dialogs for destructive operations with clear impact explanations
- **Configuration Persistence**: Settings that survive app restarts and device reboots

### Phase 5 - Phase 4 Bug Fixes  
**Status:** ‚úÖ Completed  
**Priority:** High  
**Description:** Fix bugs discovered during Phase 4 implementation and testing

#### Phase Progress
**Phase 5 Bug Fixes Implementation:**
- ‚úÖ COMPLETED: Fix persistent success messages across screen navigation (Export/Import/Purge states not resetting)
- ‚úÖ COMPLETED: Fix Import not correctly detecting duplicate visits
- ‚ùå TODO: Additional bug fixes as discovered during testing

#### Bug Details
**Persistent Success Messages Bug (FIXED):**
- Issue: Export/Import success messages would reappear when returning to Settings after navigation
- Root Cause: ViewModels retaining state across screen lifecycle
- Solution: Added resetStates() methods called in onDestroyView()

**Import Duplicate Visit Detection Bug (FIXED):**
- Issue: Import process not correctly identifying duplicate visits during data import
- Impact: Could result in duplicate visit records in database during import operations
- Root Cause: Import logic was not checking for existing visits before inserting new ones
- Solution: Added getVisitByVenueAndTimestamp() method to check for duplicates based on venue and timestamp

#### Technical Implementation Details
**State Management Fix:**
- Added resetStates() methods to ImportExportViewModel and PurgeDataViewModel
- Properly clear all StateFlow values when fragments are destroyed
- Ensures clean slate on each screen entry

**Duplicate Visit Detection Fix:**
- Added getVisitByVenueAndTimestamp() method to VisitDao for duplicate checking
- Enhanced repository with visit duplication detection capability
- Modified ImportExportViewModel to check for existing visits before insertion
- Duplicate detection logic: visits with same venueId and timestamp are considered duplicates
- Maintains ID mapping for performance records even when visits are duplicates

#### Technical Requirements from PlayStreak Patterns
**Enhanced Data Overview Display:**
- **Entity Counts**: Songs, Venues, Visits, Performances, Song-Venue Associations
- **Relationship Statistics**: Songs per venue averages, venues per song averages
- **Activity Metrics**: Total performance time estimates, visit frequency analysis
- **Storage Usage**: Current data usage vs limits (500 visit cap)

**Import/Export System (PlayStreak Architecture):**
- **JSON Export**: Complete data export with all relationships preserved
- **Import Validation**: Pre-import data validation and conflict detection
- **Atomic Operations**: All-or-nothing import process with rollback capability
- **Progress Indicators**: User feedback during large import/export operations

**Purge Data Implementation (Enhanced from PlayStreak):**
- **Intelligent Purging**: Remove oldest visits while preserving essential statistics
- **Statistics Preservation**: Maintain performance counts and last-performed dates
- **User Confirmation**: Clear warning dialogs with data impact preview
- **Export Recommendation**: Suggest data export before purging operations

**Clear Data Debug Functionality:**
- **Debug Build Only**: Button only visible and functional in debug builds (BuildConfig.DEBUG)
- **Complete Data Wipe**: Clear all database tables (songs, venues, visits, performances, song_venue_info)
- **Development Reset**: Reset app to fresh state for testing new user scenarios
- **Confirmation Dialog**: Multiple confirmation steps to prevent accidental data loss
- **Build Type Detection**: Use BuildConfig.DEBUG to control feature availability
- **Database Transaction**: Atomic operation to ensure complete clearing or rollback on failure
- **UI State Reset**: Clear any cached data in ViewModels and refresh all screens
- **Testing Support**: Enable rapid testing of onboarding flows and empty state handling

## Cycle Notes
- Building on the complete navigation and CRUD foundation from DevCycle 3
- Addressing the highest priority deferred feature (Song-Venue Associations) first
- Following PlayStreak's proven Import/Export and Settings patterns
- Enhancing search capabilities based on user activity patterns from design scenarios
- Maintaining focus on live karaoke venue usage and offline-first design

## Design Document Reference
This cycle directly addresses advanced workflow requirements from `docs/Initial_Singventory_Design.md`:

**Enhanced Impromptu Visit Scenario:**
- Quick song-venue association during venue visits (Phase 1)
- Ability to correct and update venue information discovered during visits (Phase 2)

**Advanced Recon Visit Scenario:**  
- Pre-visit venue preparation with bulk song association (Phase 1)
- Comprehensive venue information management for research visits (Phase 2)

**Optimized Repeat Visit Scenario:**
- Enhanced search capabilities for efficient song selection (Phase 3)
- Complete venue-specific song catalogs with all venue IDs and keys (Phase 1)

**Data Management Requirements:**
- Import/Export functionality as specified (Phase 4)
- Purge Data with statistics preservation as designed (Phase 4)
- Settings screen with comprehensive data overview (Phase 4)

## Future Cycles

### Potential DevCycle 5 Features
- **Advanced Analytics**: Performance pattern analysis, venue preference insights
- **Backup and Sync**: Optional cloud synchronization for data safety
- **Key Reference Audio**: Audio playback for key reference (high technical complexity)
- **Bulk Operations**: Mass song/venue management and batch editing capabilities
- **Search Enhancements**: Saved searches, advanced filtering with complex criteria
- **User Experience Improvements**: Customizable UI, accessibility enhancements

### Integration Opportunities
- **PlayStreak Code Reuse**: Direct adaptation of Import/Export, Settings, and Configuration systems
- **Material Design Evolution**: Enhanced UI patterns based on user feedback from DevCycle 3
- **Performance Optimization**: Database query optimization for large datasets

## Cycle Completion Summary
*[To be added when cycle is completed]*