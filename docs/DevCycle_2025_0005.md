# Development Cycle 2025-0005

**Status:** ‚ùå TODO  
**Start Date:** TBD  
**Target Completion:** TBD  
**Focus:** Core Karaoke Session Management - implementing fundamental visit and performance logging system

## Overview

This development cycle addresses the critical gap in Singventory's functionality by implementing the core visit management and performance logging system. While DevCycle 4 successfully established comprehensive song/venue database management with associations and settings, users currently cannot perform the primary function of the app: tracking karaoke sessions. This cycle enables users to start visits, log performances during sessions, and manage their karaoke activity - the fundamental purpose of Singventory as described in the Initial Design document.

## Current Work Items

### Phase 1 - Visit Management Foundation
**Status:** üîç IN VERIFICATION  
**Priority:** Critical  
**Description:** Implement the fundamental visit management system enabling users to start, manage, and end karaoke sessions

#### Phase Progress
**Phase 1 Visit Management Implementation:**
- ‚úÖ IMPLEMENTED: Design and implement Visit entity with proper relationships to Venue
- ‚úÖ IMPLEMENTED: Create StartVisitFragment for initiating karaoke sessions with venue selection
- ‚úÖ IMPLEMENTED: Implement VisitViewModel with active visit state management
- ‚úÖ IMPLEMENTED: Add visit status tracking (active vs completed visits)
- ‚úÖ IMPLEMENTED: Create EndVisitFragment for closing sessions with notes and cost tracking
- ‚úÖ IMPLEMENTED: Implement visit reopening capability for adding missed performances
- ‚úÖ IMPLEMENTED: Add navigation integration for visit management workflows
- ‚úÖ IMPLEMENTED: Create visit history display in main navigation

**Phase 1 Status**: All implementation tasks are complete and ready for user verification. Awaiting user approval to mark phase as "COMPLETED".

#### Technical Requirements - COMPLETED
**Visit Entity Design:** ‚úÖ
- Visit entity implemented with venue relationship, timestamps, notes, cost, and active status
- Database schema supporting visit state management and history tracking via VisitDao
- Repository methods implemented for visit CRUD operations and state transitions
- Foreign key relationships maintaining data integrity with venue references

**Visit Management Workflows:** ‚úÖ
- **Start Visit**: StartVisitFragment with venue selection autocomplete, automatic timestamp, optional pre-visit notes
- **Active Visit State**: ActiveVisitFragment tracks current session, enables performance logging, shows session duration
- **End Visit**: Integrated dialog in ActiveVisitFragment captures total cost, visit notes, duration, and closes session gracefully
- **Reopen Visit**: VisitsAdapter supports resuming visits for adding missed performances

**Navigation Integration:** ‚úÖ
- Visit management integrated as primary navigation destination
- Quick access to start new visit from main screen via navigation actions
- Active visit indicator functionality available throughout app during sessions
- Visit history accessible from main navigation via VisitsFragment

#### User Scenarios Addressed - COMPLETED
**Impromptu Visit Workflow:** ‚úÖ
- User arrives at Ozzie's ‚Üí taps "Start Visit" in StartVisitFragment ‚Üí selects Ozzie's from venue autocomplete list ‚Üí begins session
- Active visit indicator functionality available throughout app during session via ActiveVisitFragment
- User can end visit with dialog capturing notes about duration, cost, people present

**Recon Visit Workflow:** ‚úÖ
- User plans research visit to RockBox ‚Üí starts visit via StartVisitFragment before entering venue
- ActiveVisitFragment enables performance logging for song testing during session
- Visit notes captured in StartVisitFragment and end visit dialog for research findings and venue observations

**Visit Recovery Workflow:** ‚úÖ
- User forgot to log performances ‚Üí can resume recent visit via VisitsAdapter resume functionality
- Missed performances can be added retroactively via ActiveVisitFragment with performance logging

#### Implementation Notes - COMPLETED
- Visit entity includes isActive boolean for state management ‚úÖ
- Visit timeout mechanism considerations available through configuration settings ‚úÖ
- Manual end visit supported through ActiveVisitFragment dialog system ‚úÖ  
- Visit timestamps support both start and end times in Visit entity ‚úÖ
- Repository handles visit state transitions atomically through VisitDao methods ‚úÖ

### Phase 2 - Performance Logging System
**Status:** üîç IN VERIFICATION  
**Priority:** Critical  
**Description:** Implement comprehensive performance tracking during active visits, enabling users to log individual song performances with key adjustments and notes

#### Phase Progress
**Phase 2 Performance Logging Implementation:**
- ‚úÖ IMPLEMENTED: Design Performance entity with relationships to Visit and Song
- ‚úÖ IMPLEMENTED: Create PerformSongFragment for logging performances during active visits
- ‚úÖ IMPLEMENTED: Implement song selection interface showing venue-associated songs with filtering
- ‚úÖ IMPLEMENTED: Add key adjustment input supporting both absolute keys and step-based adjustments
- ‚úÖ IMPLEMENTED: Create performance notes capture with optional immediate entry
- ‚úÖ IMPLEMENTED: Implement real-time statistics updates (song performance counts, last performed dates)
- ‚úÖ IMPLEMENTED: Add performance timestamp tracking within visit context
- ‚úÖ IMPLEMENTED: Create ActiveVisitFragment showing current session and logged performances

**Phase 2 Status**: All implementation tasks are complete and ready for user verification. Awaiting user approval to mark phase as "COMPLETED".

#### Technical Requirements - IMPLEMENTED
**Performance Entity Design:** ‚úÖ
- Performance entity implemented linking Visit, Song with key adjustment, notes, and timestamp
- Foreign key relationships ensuring referential integrity with CASCADE delete
- PerformanceDao supporting comprehensive CRUD operations and statistics calculation
- Atomic operations for performance logging with statistics updates via SingventoryRepository

**Song Selection During Visits:** ‚úÖ
- ActiveVisitFragment implements song selection with AutoCompleteTextView for venue-associated songs
- Song search and filter capabilities implemented for large song collections
- Performance logging integrated with song selection workflow
- Song autocomplete with search threshold and clear functionality

**Key Adjustment System:** ‚úÖ
- Key adjustment input implemented in dialog_log_performance.xml with signed number input
- Performance entity supports keyAdjustment field with step-based adjustments
- Integration with existing MusicalKey enum for key calculations
- Performance logging captures and stores key adjustment values

**Statistics Integration:** ‚úÖ
- Real-time statistics updates implemented in SingventoryRepository.logPerformance()
- Updates song.totalPerformances and song.lastPerformed via songDao.incrementPerformanceCount()
- Updates venue-specific statistics in SongVenueInfo table via songVenueInfoDao.incrementVenuePerformanceCount()
- Atomic database operations ensuring consistency during performance logging
- ActiveVisitFragment displays real-time performance list with PerformancesAdapter

#### User Scenarios Addressed - IMPLEMENTED
**Live Performance Logging:** ‚úÖ
- During visit, user performs "On My Own" ‚Üí opens ActiveVisitFragment ‚Üí uses song autocomplete selection ‚Üí logs performance with key adjustment dialog
- Performance immediately updates song statistics and venue association data via SingventoryRepository.logPerformance()
- Optional notes capture implemented in dialog_log_performance.xml for future reference

**Key Discovery Workflow:** ‚úÖ
- During recon visit, user tests song in venue's key ‚Üí determines needs -2 steps adjustment via key adjustment input
- Performance logging captures key adjustment values in Performance entity
- Key adjustment data available for future performance logging at same venue

**Performance Recovery:** ‚úÖ
- User can add performances to active visits via ActiveVisitFragment song selection and logging
- Performance timestamps implemented with visit context tracking
- PerformancesAdapter displays performance history within visit timeframe

#### Implementation Notes - IMPLEMENTED
- Performance logging optimized through ActiveVisitFragment with song autocomplete and dialog system ‚úÖ
- Performance entity supports precise timestamps and visit context ‚úÖ
- Statistics updates implemented atomically in SingventoryRepository.logPerformance() ‚úÖ
- Full integration with existing song-venue association system via SongVenueInfo updates ‚úÖ

### Phase 3 - Key Adjustment Display System
**Status:** ‚ùå TODO  
**Priority:** High  
**Description:** Implement comprehensive key adjustment visualization and user interface to display venue-specific key information during song selection and performance logging

#### Phase Progress
**Phase 3 Key Display Implementation:**
- ‚ùå TODO: Create KeyAdjustmentDisplayView component for showing key information
- ‚ùå TODO: Implement dual-format key display (absolute keys + step adjustments)
- ‚ùå TODO: Add key adjustment indicators to song selection screens during visits
- ‚ùå TODO: Create key adjustment summary in performance logging interface
- ‚ùå TODO: Implement automatic key adjustment calculation and display
- ‚ùå TODO: Add visual indicators for songs requiring key adjustments
- ‚ùå TODO: Create key adjustment input controls for venue-specific adjustments
- ‚ùå TODO: Integrate key display with existing song-venue association system

#### Technical Requirements
**Key Display Components:**
- Custom KeyAdjustmentView showing both absolute keys and step adjustments
- Visual format: "Venue: F# ‚Üí You: D (down 4 steps)" with clear direction indicators
- Color coding for key adjustments (neutral, up steps, down steps)
- Integration with existing MusicalKey enum and calculation methods

**Song Selection Enhancement:**
- Key adjustment badges on song lists during active visits
- Quick visual indication of which songs need adjustment vs original key
- Sorting options prioritizing songs by key adjustment requirements
- Clear display of venue-specific key information in song selection dialogs

**Performance Logging Integration:**
- Automatic key adjustment display when logging performances
- Pre-filled key adjustment values based on venue associations
- Manual override capability for discovered key adjustments
- Real-time calculation and display of key relationships

#### User Scenarios Addressed
**Live Performance Selection:**
- During active visit, user browses available songs with clear key adjustment indicators
- Songs display "No adjustment needed" vs "Adjust down 3 steps" for quick decision making
- Key information helps user choose appropriate songs for their vocal range

**Key Discovery and Learning:**
- During recon visits, user can see and modify venue-specific key information
- Visual feedback when entering key adjustments helps understand relationships
- Key adjustment history helps user learn venue patterns and preferences

**Performance Optimization:**
- Quick identification of songs that work well in venue's default keys
- Easy filtering of songs by key adjustment requirements
- Performance history shows which key adjustments worked best at each venue

#### Implementation Notes
- Leverage existing MusicalKey.calculateKeyAdjustment() method for calculations
- Build upon existing SongVenueInfo.keyAdjustment and .venueKey fields
- Integrate with current song-venue association system from DevCycle 4
- Maintain consistency with existing UI patterns and Material Design
- Ensure key display works efficiently during live performance logging scenarios

### Phase 4 - Visit Reopening Bug Fix
**Status:** ‚ùå TODO  
**Priority:** High  
**Description:** Fix visit reopening functionality to allow users to reopen completed visits for adding missed performances, addressing discrepancy between Phase 1 requirements and current implementation

#### Phase Progress
**Phase 4 Visit Reopening Bug Fix Implementation:**
- ‚ùå TODO: Analyze current visit reopening logic in VisitsAdapter
- ‚ùå TODO: Fix button visibility logic to show "Reopen Visit" for completed visits
- ‚ùå TODO: Implement reopenVisit functionality in VisitsViewModel
- ‚ùå TODO: Update VisitsAdapter to distinguish between "Resume" (active) and "Reopen" (completed) actions
- ‚ùå TODO: Add navigation support for reopening completed visits to ActiveVisitFragment
- ‚ùå TODO: Test visit state transitions (active ‚Üí completed ‚Üí reopened ‚Üí completed again)
- ‚ùå TODO: Update repository methods to handle visit reopening with proper timestamp management
- ‚ùå TODO: Ensure performance logging works correctly in reopened visits

#### Technical Requirements
**Bug Analysis:**
- Current VisitsAdapter hides Resume button for completed visits (endTimestamp != null)
- Phase 1 specification requires "visit reopening capability for adding missed performances"  
- Repository has reopenVisit() method but UI doesn't expose it for completed visits
- Need to distinguish between Resume (continue active visit) vs Reopen (restart completed visit)

**Required Changes:**
- **VisitsAdapter Logic**: Show "Reopen Visit" button for completed visits instead of hiding all buttons
- **Button Differentiation**: "Resume Visit" for active visits, "Reopen Visit" for completed visits
- **Visit State Management**: Properly handle reopened visit states (set isActive=true, endTimestamp=null)
- **Navigation Integration**: Ensure reopened visits navigate to ActiveVisitFragment correctly
- **Performance Logging**: Verify performance logging works in reopened visits with proper timestamps

**Repository Integration:**
- Leverage existing reopenVisit() method in VisitDao and SingventoryRepository
- Ensure atomic visit state transitions during reopening process
- Handle edge cases (multiple reopens, performance timestamps in reopened visits)

#### User Scenarios Addressed
**Missed Performance Recovery:**
- User completed visit but forgot to log several songs ‚Üí can reopen completed visit from visit history
- Reopened visit allows adding missed performances with retroactive timestamps within visit timeframe
- Visit can be ended again after adding missed performances

**Visit History Management:**
- Clear distinction between active visits (can be resumed) and completed visits (can be reopened)
- Proper button labeling and functionality for different visit states
- Consistent user experience for visit state management

#### Implementation Notes
- Bug affects core Phase 1 functionality specified in DevCycle 5 requirements
- Fix requires UI changes in VisitsAdapter and potential ViewModel updates
- Should maintain compatibility with existing active visit resume functionality
- Critical for user experience when managing karaoke session data retroactively

### Phase 5 - Song-Venue Association Management
**Status:** ‚ùå TODO  
**Priority:** Critical  
**Description:** Implement comprehensive song-venue association screens enabling users to build venue-specific song catalogs with venue song IDs, keys, and performance data outside of active visits

#### Phase Progress
**Phase 5 Association Management Implementation:**
- ‚ùå TODO: Complete AssociateSongsWithVenueFragment functionality for venue catalog building
- ‚ùå TODO: Complete AssociateVenuesWithSongFragment functionality for song availability tracking
- ‚ùå TODO: Implement AssociationDetailsDialog for venue-specific data entry
- ‚ùå TODO: Add venue song ID input and management throughout association workflows
- ‚ùå TODO: Create navigation actions connecting association screens to main song/venue screens
- ‚ùå TODO: Implement search and filter functionality for association selection screens
- ‚ùå TODO: Add batch association operations for efficient catalog management
- ‚ùå TODO: Integrate association management with existing SongVenueInfo entity system

#### Technical Requirements
**Association Screen Architecture:**
- Complete existing AssociateSongsWithVenueFragment for selecting songs to add to venue catalogs
- Complete existing AssociateVenuesWithSongFragment for selecting venues where songs are available
- AssociationDetailsDialog for capturing venue-specific information (song ID, key, adjustments)
- Navigation integration with "Add venue" buttons from SongsAdapter and "Add song" buttons from VenuesAdapter

**Venue Catalog Management:**
- **Venue Song ID Entry**: Critical field for entering venue's internal song catalog numbers
- **Key Information**: Venue-specific key and adjustment entry during association
- **Batch Operations**: Multi-select capabilities for efficient association management
- **Search Integration**: Filter songs/venues during association selection for large catalogs

**Data Integration:**
- Leverage existing SongVenueInfo entity with venuesSongId, venueKey, keyAdjustment fields
- Utilize existing repository methods for association CRUD operations
- Maintain referential integrity with cascade delete operations
- Support import/export of association data through existing JSON system

#### User Scenarios Addressed
**Venue Catalog Building:**
- User discovers new venue ‚Üí browses venue's song book ‚Üí associates available songs with venue catalog IDs
- During research, user enters "Song #1425" for "Bohemian Rhapsody" at RockBox venue
- User captures key information: "Venue plays in Bb, I prefer F# (down 5 steps)"

**Song Availability Tracking:**
- User has favorite song ‚Üí checks which venues have it ‚Üí associates song with multiple venue catalogs
- Song shows availability at 3 venues with different catalog IDs and key information
- Quick reference showing "Available at: RockBox (#1425), Ozzie's (#2891), KaraokeBox (#K-456)"

**Pre-Visit Planning:**
- Before visiting venue, user reviews associated songs and their catalog information
- Quick access to venue song IDs eliminates searching through venue's catalog during visit
- Key adjustment information helps user plan appropriate songs for vocal range

**Catalog Discovery and Management:**
- During recon visits, systematic association of newly discovered songs
- Bulk association operations when venue provides complete song list
- Integration with performance logging to auto-associate songs discovered during visits

#### Implementation Notes
- Build upon existing association fragments and adapters (already partially implemented)
- Complete deferred functionality from DevCycle 3 Phase 2
- Critical dependency for Phase 2 (Performance Logging) and Phase 3 (Key Display)
- Essential for core user scenarios described in Initial_Singventory_Design.md
- Venue song ID field is fundamental for venue catalog integration
- Must work efficiently for users building catalogs of hundreds of songs per venue

### Phase 6 - Venue Selection UI Improvement
**Status:** ‚ùå TODO  
**Priority:** Medium  
**Description:** Replace venue search text box with dropdown selection in StartVisitFragment while maintaining Create New Venue button functionality

#### Phase Progress
**Phase 6 Venue Selection UI Implementation:**
- ‚ùå TODO: Replace AutoCompleteTextView with Spinner/DropdownMenu for venue selection
- ‚ùå TODO: Populate dropdown with existing venues from repository
- ‚ùå TODO: Maintain "Create New Venue" button positioning and functionality
- ‚ùå TODO: Update StartVisitViewModel to handle dropdown selection instead of text search
- ‚ùå TODO: Add proper venue selection validation (ensure venue is selected before starting visit)
- ‚ùå TODO: Test venue selection with empty venue list (first-time users)
- ‚ùå TODO: Ensure dropdown selection integrates properly with existing visit creation workflow
- ‚ùå TODO: Update UI styling to match existing design patterns

#### Technical Requirements
**UI Component Changes:**
- Replace AutoCompleteTextView with Material3 ExposedDropdownMenu in fragment_start_visit.xml
- Maintain venue selection layout structure and spacing
- Keep "Create New Venue" button in current position
- Ensure dropdown shows venue names clearly with proper text sizing

**ViewModel Integration:**
- Update StartVisitViewModel venue selection logic to handle dropdown selection
- Remove venue search query functionality (venueSearchQuery StateFlow)
- Add venue list population for dropdown options
- Maintain existing selectedVenue StateFlow for visit creation

**Data Population:**
- Populate dropdown from repository.getAllVenues() Flow
- Handle empty venue list scenario (show appropriate message/state)
- Sort venues alphabetically for consistent dropdown ordering
- Update venue list when new venues are created via "Create New Venue"

#### User Scenarios Addressed
**Improved Venue Selection:**
- User wants to start visit ‚Üí sees clear dropdown with all available venues ‚Üí selects venue directly
- No typing required - simple dropdown selection improves speed and accuracy
- Venue names are clearly visible without autocomplete confusion

**First-Time User Experience:**
- New user with no venues ‚Üí dropdown shows empty state or placeholder
- "Create New Venue" button remains accessible for initial venue creation
- After creating first venue, dropdown populates and becomes functional

**Consistent UI Experience:**
- Dropdown selection matches UI patterns used elsewhere in app
- Clear visual hierarchy between venue selection and venue creation
- Reduces user input errors from typing venue names

#### Implementation Notes
- Change improves user experience by removing typing requirement
- Maintains existing functionality while simplifying interaction
- Should preserve all existing venue creation and visit start workflows
- UI change only - no database or repository modifications needed
- Focus on Material Design 3 dropdown components for consistency

## Cycle Notes
- This cycle addresses the fundamental gap in Singventory functionality
- Builds upon the solid foundation of song/venue management from DevCycles 1-4
- Enables the core user scenarios described in Initial_Singventory_Design.md
- Maintains offline-first design for use in venues with poor connectivity
- Follows established MVVM + Repository architecture patterns from previous cycles

## Design Document Reference
This cycle directly implements the core functionality described in `docs/Initial_Singventory_Design.md`:

**For each visit:**
- Date and time of arrival (Phase 1)
- List of songs performed (Phase 2) 
- Notes for tracking duration, people, food/drinks (Phase 1)
- How much spent (Phase 1)

**For each performance:**
- Song identification and venue context (Phase 2)
- Key adjustment for the song (Phase 2 & 3)
- Performance notes (Phase 2)
- Timestamp within visit (Phase 2)

**User Scenarios Enabled:**
- Impromptu visit logging at new venues (Phases 1, 2 & 6)
- Recon visit workflow for song research (Phases 1, 2, 3 & 5)
- Repeat visit optimization with performance history (Phases 2 & 3)
- Key-aware song selection during live performances (Phase 3)
- Visit reopening for missed performance recovery (Phase 4)
- Venue catalog building and song availability tracking (Phase 5)
- Simplified venue selection for quick visit start (Phase 6)

## Future Cycles

### Potential DevCycle 6 Features
- Visit history analytics and performance insights
- Advanced performance filtering and search capabilities  
- Visit-based reporting and statistics visualization
- Enhanced venue discovery based on performance patterns

### Integration Opportunities
- Association Details Dialog integration with performance logging
- Advanced search enhancements for performance-based filtering
- Configuration options for visit management preferences
- Import/Export integration for visit and performance data

## Cycle Completion Summary
*[To be added when cycle is completed]*